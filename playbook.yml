---

- hosts: pi
  roles:
    - role: systemli.sshd
      tags: sshd
      when: ssh_key is defined

    - role: systemli.hidden-service
      tags: hidden_service
      when: ssh_key is defined

  tasks:
    - name: Add public ssh key
      authorized_key:
        user: pi
        key: "{{ lookup('file', '{{ ssh_key }}') }}"
      when: ssh_key is defined

    - name: Mount external HDD
      mount:
        path: /srv
        src: "{{ hdd }}"
        fstype: ext4
        opts: noatime,noexec,nosuid
        state: mounted
      when: hdd is defined

    - name: External HDD is owned by pi
      file:
        path: /srv
        state: directory
        recurse: true
        owner: pi
      when: hdd is defined

    - name: Install packages
      apt:
        name: "{{ item }}"
        state: present
      with_items:
        - p7zip-full
        - watchdog
      tags: watchdog

    - name: Start watchdog
      service:
        name: watchdog
        state: started
        enabled: True
      tags: watchdog

    - name: Configure watchdog
      lineinfile:
        path: /etc/watchdog.conf
        regexp: "#?watchdog-device\\s*="
        line: "watchdog-device         = /dev/watchdog"
      tags: watchdog

- hosts: pi
  roles:
    - { role: debops.unattended_upgrades, tags: unattended_upgrades }
    - { role: elboletaire.transmission, tags: transmission }
    - { role: tschifftner.samba, tags: samba }
    - { role: t2d.raspotify, tags: raspotify }
    - { role: t2d.hifiberry, tags: hifiberry }
